<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cadastrar Imagens - Prototipo-Scan</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>Prototipo-Scan</h1>
            <p class="subtitle">Cadastro de Imagens</p>
            <nav class="nav-menu">
                <a href="/" class="nav-link">Buscar</a>
                <a href="/categories" class="nav-link">Categorias</a>
                <a href="/upload" class="nav-link active">Cadastrar Imagens</a>
            </nav>
        </header>

        <main>
            <section class="upload-section">
                <h2>Adicionar Nova Imagem</h2>
                
                <div class="form-group">
                    <label for="categorySelect">Categoria *</label>
                    <select id="categorySelect" required>
                        <option value="">Selecione uma categoria</option>
                    </select>
                </div>
                
                <div class="upload-area" id="uploadArea">
                    <input type="file" id="imageInput" accept="image/*" hidden>
                    <div class="upload-content">
                        <svg class="upload-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                            <polyline points="17 8 12 3 7 8"/>
                            <line x1="12" y1="3" x2="12" y2="15"/>
                        </svg>
                        <p>Clique ou arraste uma imagem aqui</p>
                        <span class="file-types">JPG, PNG, GIF, WEBP</span>
                    </div>
                </div>

                <div class="preview-container" id="previewContainer" style="display: none;">
                    <img id="previewImage" alt="Preview da imagem">
                    <button class="btn btn-secondary" id="clearBtn">Limpar</button>
                </div>

                <button class="btn btn-primary" id="uploadBtn" disabled>
                    <span class="btn-text">Cadastrar Imagem</span>
                    <span class="btn-loading" style="display: none;">
                        <svg class="spinner" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="3" fill="none" stroke-dasharray="30 70"/>
                        </svg>
                        Processando...
                    </span>
                </button>
            </section>

            <section class="success-section" id="successSection" style="display: none;">
                <div class="success-card">
                    <svg class="success-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                        <polyline points="22 4 12 14.01 9 11.01"/>
                    </svg>
                    <p>Imagem cadastrada com sucesso!</p>
                    <button class="btn btn-primary" id="addAnotherBtn">Adicionar Outra</button>
                </div>
            </section>

            <section class="error-section" id="errorSection" style="display: none;">
                <div class="error-card">
                    <svg class="error-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <line x1="15" y1="9" x2="9" y2="15"/>
                        <line x1="9" y1="9" x2="15" y2="15"/>
                    </svg>
                    <p id="errorMessage">Erro ao cadastrar a imagem</p>
                </div>
            </section>

            <section class="images-section">
                <h2>Imagens Cadastradas</h2>
                <div class="filter-group">
                    <label for="filterCategory">Filtrar por categoria:</label>
                    <select id="filterCategory">
                        <option value="">Todas as categorias</option>
                    </select>
                </div>
                <div class="images-grid" id="imagesGrid">
                    <p class="loading">Carregando imagens...</p>
                </div>
            </section>
        </main>

        <footer>
            <p>Desenvolvido com CLIP + FAISS</p>
        </footer>
    </div>

    <div class="modal" id="deleteModal" style="display: none;">
        <div class="modal-content">
            <h3>Confirmar Exclusão</h3>
            <p>Tem certeza que deseja excluir esta imagem?</p>
            <div class="modal-actions">
                <button class="btn btn-secondary" id="cancelDeleteBtn">Cancelar</button>
                <button class="btn btn-danger" id="confirmDeleteBtn">Excluir</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const uploadArea = document.getElementById('uploadArea');
            const imageInput = document.getElementById('imageInput');
            const previewContainer = document.getElementById('previewContainer');
            const previewImage = document.getElementById('previewImage');
            const clearBtn = document.getElementById('clearBtn');
            const uploadBtn = document.getElementById('uploadBtn');
            const categorySelect = document.getElementById('categorySelect');
            const filterCategory = document.getElementById('filterCategory');
            const imagesGrid = document.getElementById('imagesGrid');
            const successSection = document.getElementById('successSection');
            const errorSection = document.getElementById('errorSection');
            const errorMessage = document.getElementById('errorMessage');
            const addAnotherBtn = document.getElementById('addAnotherBtn');
            const deleteModal = document.getElementById('deleteModal');
            const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');
            const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');

            let selectedFile = null;
            let imageToDelete = null;

            loadCategories();
            loadImages();

            uploadArea.addEventListener('click', () => imageInput.click());
            
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });
            
            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });
            
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                if (e.dataTransfer.files.length > 0) {
                    handleFile(e.dataTransfer.files[0]);
                }
            });
            
            imageInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handleFile(e.target.files[0]);
                }
            });

            clearBtn.addEventListener('click', clearSelection);
            
            uploadBtn.addEventListener('click', uploadImage);
            
            addAnotherBtn.addEventListener('click', () => {
                successSection.style.display = 'none';
                uploadArea.style.display = 'block';
            });

            categorySelect.addEventListener('change', updateUploadButton);
            
            filterCategory.addEventListener('change', () => {
                loadImages(filterCategory.value);
            });

            cancelDeleteBtn.addEventListener('click', () => {
                deleteModal.style.display = 'none';
                imageToDelete = null;
            });

            confirmDeleteBtn.addEventListener('click', async () => {
                if (!imageToDelete) return;
                
                try {
                    const response = await fetch(`/api/images/${imageToDelete}`, {
                        method: 'DELETE'
                    });
                    
                    if (response.ok) {
                        loadImages(filterCategory.value);
                    } else {
                        const data = await response.json();
                        alert(data.error || 'Erro ao excluir imagem');
                    }
                } catch (error) {
                    alert('Erro de conexão. Tente novamente.');
                }
                
                deleteModal.style.display = 'none';
                imageToDelete = null;
            });

            function handleFile(file) {
                if (!file.type.startsWith('image/')) {
                    showError('Por favor, selecione um arquivo de imagem.');
                    return;
                }

                selectedFile = file;
                const reader = new FileReader();
                
                reader.onload = (e) => {
                    previewImage.src = e.target.result;
                    previewContainer.style.display = 'block';
                    uploadArea.style.display = 'none';
                    updateUploadButton();
                };
                
                reader.readAsDataURL(file);
            }

            function clearSelection() {
                selectedFile = null;
                imageInput.value = '';
                previewContainer.style.display = 'none';
                uploadArea.style.display = 'block';
                successSection.style.display = 'none';
                errorSection.style.display = 'none';
                updateUploadButton();
            }

            function updateUploadButton() {
                uploadBtn.disabled = !selectedFile || !categorySelect.value;
            }

            async function uploadImage() {
                if (!selectedFile || !categorySelect.value) return;

                const btnText = uploadBtn.querySelector('.btn-text');
                const btnLoading = uploadBtn.querySelector('.btn-loading');
                
                btnText.style.display = 'none';
                btnLoading.style.display = 'flex';
                uploadBtn.disabled = true;
                errorSection.style.display = 'none';

                const formData = new FormData();
                formData.append('image', selectedFile);
                formData.append('category_id', categorySelect.value);

                try {
                    const response = await fetch('/api/images', {
                        method: 'POST',
                        body: formData
                    });

                    const data = await response.json();

                    if (response.ok) {
                        previewContainer.style.display = 'none';
                        successSection.style.display = 'block';
                        selectedFile = null;
                        imageInput.value = '';
                        loadImages(filterCategory.value);
                    } else {
                        showError(data.error || 'Erro ao cadastrar imagem.');
                    }
                } catch (error) {
                    showError('Erro de conexão. Tente novamente.');
                } finally {
                    btnText.style.display = 'inline';
                    btnLoading.style.display = 'none';
                    updateUploadButton();
                }
            }

            function showError(message) {
                errorMessage.textContent = message;
                errorSection.style.display = 'block';
            }

            async function loadCategories() {
                try {
                    const response = await fetch('/api/categories');
                    const categories = await response.json();
                    
                    const options = categories.map(cat => 
                        `<option value="${cat.id}">${escapeHtml(cat.name)}</option>`
                    ).join('');
                    
                    categorySelect.innerHTML = '<option value="">Selecione uma categoria</option>' + options;
                    filterCategory.innerHTML = '<option value="">Todas as categorias</option>' + options;
                    
                    if (categories.length === 0) {
                        categorySelect.innerHTML = '<option value="">Nenhuma categoria - crie uma primeiro</option>';
                    }
                } catch (error) {
                    console.error('Erro ao carregar categorias:', error);
                }
            }

            async function loadImages(categoryId = '') {
                try {
                    const url = categoryId ? `/api/images?category_id=${categoryId}` : '/api/images';
                    const response = await fetch(url);
                    const images = await response.json();
                    
                    if (images.length === 0) {
                        imagesGrid.innerHTML = '<p class="empty-message">Nenhuma imagem cadastrada</p>';
                        return;
                    }
                    
                    imagesGrid.innerHTML = images.map(img => `
                        <div class="image-card">
                            <div class="image-thumb">
                                <img src="/images/${img.filename}" alt="${escapeHtml(img.original_filename)}" loading="lazy">
                            </div>
                            <div class="image-info">
                                <span class="image-category">${escapeHtml(img.category?.name || 'Sem categoria')}</span>
                                <span class="image-name" title="${escapeHtml(img.original_filename)}">${escapeHtml(img.original_filename)}</span>
                            </div>
                            <button class="btn btn-small btn-danger delete-image-btn" onclick="deleteImage(${img.id})">
                                Excluir
                            </button>
                        </div>
                    `).join('');
                } catch (error) {
                    imagesGrid.innerHTML = '<p class="error-message">Erro ao carregar imagens</p>';
                }
            }

            window.deleteImage = function(id) {
                imageToDelete = id;
                deleteModal.style.display = 'flex';
            };

            function escapeHtml(text) {
                if (!text) return '';
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
        });
    </script>
</body>
</html>
